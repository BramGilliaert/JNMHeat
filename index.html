<html>
<head>
	<meta charset="utf-8">
	<title>Activiteiten-Spreidings-Kaart</title>
	<link rel="stylesheet" href="vendor/leaflet/leaflet.css"/>
	<script src="vendor/leaflet/leaflet.js"></script>
	<script src="vendor/jquery-3.3.1.min.js"></script>

  <link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
  <link rel="stylesheet" href="/resources/demos/style.css">
  <script src="https://code.jquery.com/jquery-1.12.4.js"></script>
  <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
 
	<style>
		#map{ width: 1500px; height: 1050; }
	</style>
</head>
<body>




	<table id="controls" align="left">
	<tr><td><b>Activiteiten-Spreidings-Kaart (ASK)</b></td></tr>
	<tr><td>Made by Pieter Vander Vennet</td></tr>
	<tr><td>with database support of Emile</td></tr>
	<tr><td><button id="select_all">Select all</button><button id="deselect_all">Deselect all</button></td></tr>
	</table>
	<div id="map"></div>

	<table border="1">
		<tr><td>Locaties tellen mee voor geografisch centrum van zodra er minstens <input type="text" id="min_act_geocenter" placeholder="1"/> activiteiten zijn</td></tr>
		<tr><td>Activiteiten worden getoond als ze minstens <input type="text" id="min_act_duration" placeholder="0"/> uren duren</td></tr>
		<tr><td>Activiteiten worden getoond als ze maximaal <input type="text" id="max_act_duration" placeholder="0"/> uren duren</td></tr>
		<tr><td>Activiteit moet beginnen achter <input type="text" id="datepicker_after">(yyyy-mm-dd)</td></tr>
		<tr><td>Activiteit moet beginnen voor <input type="text" id="datepicker_before">(yyyy-mm-dd)</td></tr>

		<tr><td><button id="reloadSettingsButton" onclick="reloadSettings();">Apply filter</button></td></tr>
	</table>

 <script>

	// Turn true to give the analysis options and to add controls to the table with id 'controls'
	var analysisLayers = true;

	// Turn to true to load the hardcoded geojson which show the map with afdelingen for the general public 
	var publicFacingLayers = !analysisLayers;

	// --------------------- Map setup --------------------------------


	var filterSettings =
	{ geocenter_min_activities : 1 // the number of activities that a location should at least have to count against the geografical center
	, activity_starts_after : null // the day an activity shoulds start after to be rendered (and accounted for in geo center as well). Use null if not needed
	, activity_starts_before : null // the day an activity shoulds start before to be rendered (and accounted for in geo center as well). USe null if not needed
	, activity_minimal_length : 0 // the length the activity should take, in hours, to be considered
	, activity_maximal_length: NaN // The length an activity should at least take to be considered
	}

	$( "#datepicker_before" ).datepicker();
	$( "#datepicker_before" ).datepicker("option", "dateFormat", "yy-mm-dd");
	$( "#datepicker_after" ).datepicker();
	$( "#datepicker_after" ).datepicker("option", "dateFormat", "yy-mm-dd");

	function reloadSettings(){
		console.log("Updating filter settings!");
		var min_act_geocenter = parseInt(document.getElementById('min_act_geocenter').value);
		if(min_act_geocenter > 0 && min_act_geocenter != filterSettings.geocenter_min_activities){
			filterSettings.geocenter_min_activities = min_act_geocenter;
		}


		var minL = parseInt(document.getElementById('min_act_duration').value);
		if(minL >= 0 && minL != filterSettings.activity_minimal_length){
			filterSettings.activity_minimal_length = minL;
		}


		var maxL = parseInt(document.getElementById('max_act_duration').value);
		if(maxL >= 0 && minL != filterSettings.activity_maximal_length){
			filterSettings.activity_maximal_length = maxL;
		}

		var dateParts = $('#datepicker_before').val().split('-'); // Format: yyyy-mm-dd
		var date = new Date(dateParts[0], dateParts[1] - 1, dateParts[2]);
		if(date && date.valueOf()){
			filterSettings.activity_starts_before = date;
		}

		var dateParts = $('#datepicker_after').val().split('-'); // Format: yyyy-mm-dd
		var date = new Date(dateParts[0], dateParts[1] - 1, dateParts[2]);
		if(date && date.valueOf()){
			filterSettings.activity_starts_after = date;
		}

		console.log("Rendering...");
		reRender();
	}


// initialize the map
	var map = L.map('map').setView([50.9, 3.9], 9);

	// load a tile layer
	L.tileLayer('http://tile.openstreetmap.be/osmbe/{z}/{x}/{y}.png',
		{
		attribution: 'Map Data Copyright OpenStreetMap | Tiles hosted by osm.be; thx JBelien!',
		maxZoom: 21,
		minZoom: 1
		}).addTo(map);

	
	var allLayers = [];
	var controlBoxes = [];



	function reRender(){


	// cleanup of the layers which might already exist
	for(var i = 0; i < allLayers.length; i++){
		allLayers[i].hide();
		allLayers[i].scrap();
	}
	allLayers = [];
	while(controlBoxes[0] && controlBoxes[0].parentNode){
		controlBoxes[0].parentNode.removeChild(controlBoxes[0]);
	}
	controlBoxes = [];


	function newLayer(name){
		var layer = new L.FeatureGroup();
		allLayers.push(layer);


		layer.show = function(){
			map.addLayer(layer);
			if(layer.control){
				layer.control.checked = true;
			}
			return layer;
		};

		layer.hide = function(){
			map.removeLayer(layer);
			if(layer.control){
				layer.control.checked = false;
			}
			return layer;
		};
		layer.title = name;


		layer.scrap = function(){
			map.removeLayer(layer);
			if(layer.control){
				layer.control.checked = false;
				layer.control.onclick = null;
			}
		}

		function getControls(){
			return document.getElementById("layer"+layer.title)
		}

		// create controls
		function createControls(){
			var idCB = "layer"+layer.title;;
			var checkbox = document.createElement('input');
			checkbox.type = "checkbox";
			checkbox.name = "layer"+layer.title;
			checkbox.value = "value";
			checkbox.id = idCB;

			var label = document.createElement('label')
			label.htmlFor = idCB;
			label.appendChild(document.createTextNode(layer.title));

			var container = document.getElementById('controls');

			var tr = document.createElement('tr');
			controlBoxes.push(tr);
			var td = document.createElement('td');
			container.appendChild(tr);
			tr.appendChild(td);
			td.appendChild(checkbox);
			td.appendChild(label);


			layer.control = document.getElementById(idCB)
			layer.control.onclick = function() {
			 if (this.checked ) {
				layer.show();
			 } else {
				layer.hide();
			 }
			};
		}

		var controls = getControls();
		if(controls){
			layer.control = controls;
			controls.onclick =  function() {
			 if (this.checked ) {
				layer.show();
			 } else {
				layer.hide();
			 }
			};
		}else{
			createControls();
		}

		return layer;
	}

	
	function selectAll(selected){
		for(var i = 0; i < allLayers.length; i++){
			if(selected){
				allLayers[i].show();
			}else{
				allLayers[i].hide();
			}
		} 
	}

	document.getElementById('select_all').onclick = function(){
		selectAll(true);
	};
	
	document.getElementById('deselect_all').onclick = function(){
		selectAll(false);
	};

	

	// ------------------------ Icons ---------------------------------


	// fancy icons to show
	var lokaalIcon = L.icon({iconUrl: 'img/Lokaal', iconSize: [20, 20], iconAnchor: [10, 0], popupAnchor: [0,0]});
	var winkelIcon = L.icon({iconUrl: 'img/Winkel', iconSize: [20, 20], iconAnchor: [10, 0], popupAnchor: [0,0]});
	var bondssecIcon = L.icon({iconUrl: 'img/Bondssec', iconSize: [20, 20], iconAnchor: [10, 0], popupAnchor: [0,0]});
		

	var activiteitIcon = L.icon({iconUrl: 'img/VoorbijeAct', iconSize: [15,15], iconAnchor: [7, 7], popupAnchor: [0,0]});
	var activiteitenCenterIcon = L.icon({iconUrl: 'img/ActiviteitCenterIcon', iconSize: [10,10], iconAnchor: [4, 5], popupAnchor: [0,0]});
		
	var activiteitGeplandIcon = L.icon({iconUrl : 'img/ToekomstAct', iconSize: [15,15], icondAnchor: [0,0], popupAnchor: [0,0]});


	// create a dictionary {'node-id' --> node}
	function nodeDict(nodeData){
	var dict = new Object();
	for (var i = 0; i < nodeData.elements.length; i++){
		var node = nodeData.elements[i];
		if(node.type != 'node'){
			continue;
		}
		dict[node.id] = node;
	}
	return dict;

	}



	// ------------------------------------- HANDLING LOCATIONS ----------------------------------------------



	/* The string (html) that is shown on a popup of a venue
	*/
	function popupString(lokaal) {
		
		var link = lokaal.tags.website;
		if(link == null){
			link = lokaal.tags.name;
		}else{
			link = "<a href='"+lokaal.tags.website+"' target='_blank'>"+lokaal.tags.name+"</a>"
		}

		var descr;
		if(lokaal.tags.shop == "gift"){
			// This is a special case for the shop
			descr = "";;
		}else{
			// This is a generic youth movement space
			descr = "Lokaal van "
		}


		var findOn = "<br /><a href='https://openstreetmap.org/"+lokaal.type+"/"+lokaal.id+"' target='_blank'>Bekijk op kaart en Routeplanning</a>";

		return descr + link + findOn;

	}


	function pickIcon(lokaalInfo){
		if(lokaalInfo.tags.shop === "gift"){
			return winkelIcon;
		}else if(lokaalInfo.tags.office === "administrative"){
			return bondssecIcon;
		}else{
			return lokaalIcon;
		}
	}

	// load data about the spaces from file, and use it
	function createLokalenLayer(){
	var lokalenLayer = newLayer("Lokalen van JNM-afdelingen (+bondsec)");

	// query openstreetmap for venues of JNM. It looks to 'operator=JNM'
	var query = "https://overpass-api.de/api/interpreter?data=%5Bout%3Ajson%5D%5Btimeout%3A25%5D%3B%28node%5B%22operator%22%3D%22JNM%22%5D%2848%2E951366470948%2C0%2E59326171875%2C52%2E583025861416%2C8%2E6846923828125%29%3Bway%5B%22operator%22%3D%22JNM%22%5D%2848%2E951366470948%2C0%2E59326171875%2C52%2E583025861416%2C8%2E6846923828125%29%3B%29%3Bout%3B%3E%3Bout%20skel%20qt%3B%0A";


	$.get(query, function( lokalen ) {

		// maps ids on their nodes; we'll need it later
		var nodes = nodeDict(lokalen);

		for (var i = 0; i < lokalen.elements.length; i++){
			var lokaal = lokalen.elements[i];

			if(lokaal.tags == null){
				// probably just part of a building. Skip this shit
				continue;
			}

			if(lokaal.tags.name == null){
					console.log("Name not defined for location, skipping it");
					console.log(lokaal);
					continue;
			}

			if(lokaal.lat == null || lokaal.lon == null){
				lokaal.lat = nodes[lokaal.nodes[0]].lat;
				lokaal.lon = nodes[lokaal.nodes[0]].lon;
			}

			// create a marker, add it to the layer
			var lokaalM = L.marker([lokaal.lat, lokaal.lon], {icon: pickIcon(lokaal)});
			lokaalM.bindPopup(popupString(lokaal));
			lokalenLayer.addLayer(lokaalM);
		} // end of for each venue
	}); // end of data crunching for venues
	return lokalenLayer;
	}



	// ---------------------------------------------------- HANDLING ACTIVITIES -----------------------------------------------------
	
	function forEachInOverview(dict, func){
		for(var key in dict){
			if (!dict.hasOwnProperty(key) || key == null) {
				continue;
			}
			var value = dict[key];
			func(key, value);			
		}
	}


	function geoCenter(dict){
		var total = 0;
		var lat = 0;
		var lon = 0;
		
		forEachInOverview(dict, function(key, locInfo){
			if(locInfo.count >= filterSettings.geocenter_min_activities){
				lat += locInfo.count * parseFloat(locInfo.location[0]);
				lon += locInfo.count * parseFloat(locInfo.location[1]);
				total += locInfo.count;
			}

		});
		lat /= total;
		lon /= total;
		return [lat, lon];

	}






	function sortActivitiesArray(array){
		array.sort(function(a,b){
			return a.properties.start_date - b.properties.start_date;
			});
	}

	// Builds an object containing an overview of activities on each location ([lat, lon] indexed)
	function createOverview(activiteiten){
		var allActivities = new Object();

		for(var i = 0; i < activiteiten.length; i++){
			var act = activiteiten[i];			
			var startD = new Date(act.properties.start_date);
			act.properties.start_date = startD;
			var endD = new Date(act.properties.end_date);
			act.properties.end_date = endD;


			var MS_PER_HOUR = 1000*60*60;
			var duration =  Math.floor((endD - startD) / (MS_PER_HOUR));
			if(!(filterSettings.activity_minimal_length < duration)){
				console.log("Activity does not meet minimal length", duration, filterSettings.activity_minimal_length);
				continue;
			} 

			if(filterSettings.activity_maximal_length && !(duration < filterSettings.activity_maximal_length)){
				console.log("Activity does not meet maximal length, it is "+duration);
				continue;
			}

			if(filterSettings.activity_starts_before && startD >= filterSettings.activity_starts_before){
				continue;
			}

			if(filterSettings.activity_starts_after && startD <= filterSettings.activity_starts_after){
				continue;
			}

			var lat = act.properties.field_activiteit_locatie_lat;
			var lon = act.properties.field_activiteit_locatie_lon;
			
			var locationInfo = allActivities[ [lat, lon] ]
			if(locationInfo == null){
				locationInfo = { 
					location :  [lat, lon],
					activities : [],
					count : 0, 
					};
				allActivities[ [lat, lon] ] = locationInfo;
				
			}
			locationInfo.activities.push(act);
			locationInfo.count += 1;
		}


		forEachInOverview(allActivities, 
			function(w, loc){sortActivitiesArray(loc.activities);});
		return allActivities;

	}

	// Create a point for a single location
	function createLocationMarker(locationInfo){

		// locationInfo contains .activities, containing all activities
		// and a count. Lets make something neat of it!
		
		var acts = locationInfo.activities;
		
		var futureEventCount = 0;
		var pastEventCount = 0;
		var total = locationInfo.count;

		if(total < filterSettings.min_act_geo_center){
			return;
		}

		var futureEventStrings = "";
		var pastEventStrings = "";
		
		var msg;

		for(var i = 0; i < acts.length; i++){
			var act = acts[i];

			var d	=  act.properties.start_date;
			var msg = "<br /> "+ d.getFullYear() + "-" + d.getMonth() + "-" + d.getDate() + 
							": <a href='https://www.jnm.be/node/"+ act.properties.entity_id +"' target='_blank'>"+act.properties.title+"</a>";

			if(new Date(Date()) < act.properties.start_date){
				futureEventCount += 1;
				futureEventStrings += msg;
			}else{
				pastEventCount += 1;
				pastEventStrings += msg;
			}

		}

		var msg = "";
		var actIcon = activiteitIcon;
		if(futureEventCount > 0){
			msg += "<b>"+futureEventCount+" geplande activiteiten:</b>";
			msg += futureEventStrings + "<br  />";
			actIcon = activiteitGeplandIcon;
		}


		if(pastEventCount > 0){
			msg += "<b>"+pastEventCount+" voorbije activiteiten:</b>";
			msg += pastEventStrings + "<br />";
		}

		if(pastEventCount + futureEventCount >= 2){
			msg+="<br /><b>"+(pastEventCount + futureEventCount)+" activiteiten in totaal</b>";
		}

		var pin = L.marker(locationInfo.location, { icon :  actIcon});
		pin.bindPopup(msg);
		return pin;
	}


	function plotGeoCenter(afdId, afdNaam, overview, total, geoCentersLayer, icon){
				var center = geoCenter(overview);
				try{
					var geoCenterPin;
					if(icon){
						geoCenterPin = L.marker(center, {icon : icon});
					}else{
						geoCenterPin = L.marker(center);
					}
					var msg = "Geografisch centrum van <a href='https://jnm.be/afdeling/"+afdNaam+"' target='_blank'>JNM "+afdNaam+"</a><br />";
					msg += total+" activiteiten gevonden";
					geoCenterPin.bindPopup(msg);
					geoCentersLayer.addLayer(geoCenterPin);
				}catch(e){
					console.log("Could not render geocenter for "+afdId+" "+afdNaam, e, center);
				}
	}


	function createAfdelingLayer(afdId, afdNaam, geoCentersLayer){
		var layer = newLayer("activiteiten "+afdNaam);
		
		var source = "https://tools.jnm.be/jnm_heat/activiteiten_geojson.php?afdeling="+afdId;
				
		$.get(source, function(data){
				console.log("Received data for "+afdId+", rendering it...");
				var activiteitenData = JSON.parse(data).features;
				var overview = createOverview(activiteitenData);
				var total = 0;
				forEachInOverview(overview, function(loc, actData){
					total += actData.count;
					var pin = createLocationMarker(actData);
					layer.addLayer(pin);
				});
				plotGeoCenter(afdId, afdNaam, overview, total, layer, activiteitenCenterIcon);
				plotGeoCenter(afdId, afdNaam, overview, total, geoCentersLayer);
				
		});

		return layer;
	}



	// ------------------------------- MAIN PROGRAM -------------------

	// loads all the layers

	var geoCentersLayer = newLayer("geographical centers");
	createLokalenLayer().show();
	geoCentersLayer.show();
	
	if(analysisLayers){
		// load data about the spaces from file, and use it
		$.get("afdelingen.json", function( data ) {
			for(var i = 0; i < data.length; i++){
				createAfdelingLayer(data[i].id, data[i].display_name, geoCentersLayer);
			}
		});
		}
	}
	

	reRender();



	</script>


<table>
<tr><td>
<br /><br />
<h2>Hoe een activiteit toevoegen op deze kaart?</h2>

Maak een nieuwe activiteit aan op de JNM-site. De kaart update automatisch.

<h2>Ik wil enkel kampen</h2>

Gebruik hiervoor de 'minimale lengte'.

<h2>Mijn geografisch centrum wordt naar Gent gezogen</h2>

Dit komt door nationale activiteiten op je kalender. Enkel locaties met op zijn minst 2 activiteiten selecteren helpt.

<h2>Ik wil enkel dingen zien die mijn afdeling ook echt organiseert, en niet alles wat op mijn kalender gezwierd wordt</h2>

Dat is voorlopig nog niet mogelijk. Spam Emile om de queries up te daten!



<h2> Hoe een afdelingslokaal toevoegen?</h2>

<ol>
<li>Ga naar <a href="https://openstreetmap.org" target="_blank">openstreetmap.org</a></li>
<li>Ga naar de locatie van je nieuwe lokaal</li>
<li>Klik edit (indien nodig: maak een account of log in)</li>
<li>Klik op 'point' linksvanboven en klik op de locatie van je lokaal</li>
<li>Zoek links voor 'club'</li>
<li>Vul de nodige gevens in (addresvelden, naam, website naar de afdeling, eventueel een afdelings-emailadres). Vul bij voorkeur géén persoonlijke telefoonnummers of emails in; want de volgende generatie gaat vergeten dat die erop staan.</li>
<li>Vul onderin bij 'alle velden' ('all tags') nog een veld 'operator' met waarde 'JNM' in <a href="EditHelp.png" target="_blank">(dit ziet er zo uit)</a></li>
<li>Klik opslaan, geef een nuttige boodschap (zoals 'Toevoegen JNMlokaal')</li>
<li>Klik 'uploaden'</li>
<li>Klaar! Een minuutje later zou deze kaart ook up-to-date moeten zijn. Als bonus kan elke GSP-app die op OSM-gebaseerd is (OSMAND, Maps.me) je lokaal nu vinden</li>

</ol>
<h2>Wil je ook [feature] toevoegen?</h2>

Ja. Dit kan als volgt:

<!-- Ook gekend als: go fuck yourself -->
<ol>

<li><a href='https://www.w3schools.com/js/DEFAULT.asp' target='_blank'>Lees dit</a></li>
<li><a href='https://git-scm.com/docs/gittutorial' target='_blank'>Daarna dit</a></li>
<li><a href='http://github.com/pietervdvn/JNMHeat' target='_blank'>Patches welcome</a></li>
</ol>

</td>
</tr>
</table>
</body>
</html>
