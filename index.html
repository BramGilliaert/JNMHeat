<html>
<head>
	<title>In Je Buurt</title>
	<link rel="stylesheet" href="vendor/leaflet/leaflet.css"/>
	<script src="vendor/leaflet/leaflet.js"></script>
	<script src="vendor/jquery-3.3.1.min.js"></script>
	<style>
		#map{ width: 1700px; height: 900; }
	</style>
</head>
<body>

	<div id="map"></div>

 <script>

	function nodeDict(nodeData){
	var dict = new Object();
	for (var i = 0; i < nodeData.elements.length; i++){
		var node = nodeData.elements[i];
		if(node.type != 'node'){
			continue;
		}
		dict[node.id] = node;
	}
	return dict;

	}



	/* The string (html) that is shown within a popup
	*/
	function popupString(lokaal) {
		
		var link = lokaal.tags.website;
		if(link == null){
			link = lokaal.tags.name;
		}else{
			link = "<a href='"+lokaal.tags.website+"' target='_blank'>"+lokaal.tags.name+"</a>"
		}

		var descr;
		if(lokaal.tags.shop == "gift"){
			// This is a special case for the shop
			descr = "";;
		}else{
			// This is a generic youth movement space
			descr = "Lokaal van "
		}

		return descr + link;

	}



	// fancy icons to show on a venue
	var jnmIcon = L.icon({iconUrl: 'Lokaal.jpg', iconSize: [37,27], iconAnchor: [18, 0], popupAnchor: [0,0]});
	var circleIcon = L.icon({iconUrl: 'VoorbijeAct.png', iconSize: [15,15], iconAnchor: [0, 0], popupAnchor: [0,0]});
	var futureIcon = L.icon({iconUrl : 'ToekomstAct.svg', iconSize: [15,15], icondAnchor: [0,0], popupAnchor: [0,0]});


	function pickIcon(lokaalInfo){
		return jnmIcon;
	}


	// initialize the map
	var map = L.map('map').setView([50.9, 3.9], 9);

	// load a tile layer
	L.tileLayer('http://tile.openstreetmap.be/osmbe/{z}/{x}/{y}.png',
		{
		attribution: 'Map Data Copyright OpenStreetMap | Lokalendata aanpasbaar via osm.org | Activiteitendata van JNM.be | Tiles hosted by osm.be',
		maxZoom: 21,
		minZoom: 1
		}).addTo(map);





	// load data about the spaces from file, and use it
	$.get("Lokalen.geojson", function( data ) {

		var lokalen = JSON.parse(data);

		// maps ids on their nodes
		var nodes = nodeDict(lokalen);

		for (var i = 0; i < lokalen.elements.length; i++){
			var lokaal = lokalen.elements[i];

			if(lokaal.tags == null){
				// probably just part of a building. Skip this shit
				continue;
			}

			if(lokaal.tags.name == null){
					console.log("Name not defined for location, skipping it");
					console.Log(lokaal);
					continue;
			}

			if(lokaal.lat == null || lokaal.lon == null){
				lokaal.lat = nodes[lokaal.nodes[0]].lat;
				lokaal.lon = nodes[lokaal.nodes[0]].lon;
			}

			// create and show marker
			var lokaalM = L.marker([lokaal.lat, lokaal.lon], {icon: pickIcon()}).addTo(map);
			lokaalM.bindPopup(popupString(lokaal));
		} // end of for each venue
	}); // end of data crunching for venues



	function popupStringAct(act){
		return act.properties.start_date + " <a href='https://www.jnm.be/node/"+ act.properties.entity_id +"' target='_blank'>"+act.properties.title+"</a>"
		
	}


	function addActivity(act, dict){
			var lat = act.properties.field_activiteit_locatie_lat;
			var lon = act.properties.field_activiteit_locatie_lon;
		
			if(dict[ [lat, lon] ] == null){
				dict[ [lat, lon] ] = { contents : "", location : [lat, lon], count : 0, future : false };
				
			}
			dict[ [lat, lon] ].contents += popupStringAct(act) + "<br />";
			dict[ [lat, lon] ].count += 1;

			var now = new Date(Date());
			var actDate = new Date(act.properties.start_date);
			dict[ [lat, lon] ].future = dict[ [lat, lon] ].future || (now < actDate);
			
		
	}


	function geoCenter(dict){
		var total = 0;
		var lat = 0;
		var lon = 0;
		for(var key in dict){
			if (!dict.hasOwnProperty(key) || key == null) {
				continue;
			}
			var value = dict[key];

			if(value.location == null){
				console.log("Dict value without location: ", value);
				continue;
			}

			total += value.count;
			lat += value.count * parseFloat(value.location[0]);
			lon += value.count * parseFloat(value.location[1]);
		}
		
		lat /= total;
		lon /= total;
		return [lat, lon];

	}

	function createLayer(dict){

			dict.layer = new L.FeatureGroup();

			for(var key in dict){
				if (!dict.hasOwnProperty(key) || key == null) {
					continue;
				}
				var value = dict[key];
				if(value.location == null){
					console.log("Dict value without location: ", value);
					continue;
				}

				var iconToShow = circleIcon; // the grey, past icon
				if(value.future){
					iconToShow = futureIcon;
				}


				var pin = L.marker(value.location, { icon :  iconToShow});
				pin.bindPopup((value.count > 1 ? value.count+" activiteiten: <br :> ":"")+value.contents);
				dict.layer.addLayer(pin);
			}
	}

	function showPins(dict){
		map.addLayer(dict.layer);
	}

	function removePins(dict){
		map.removeLayer(dict.layer);

	}

	function handleAfdeling(afdId, afdNaam){
		var link = "https://tools.jnm.be/jnm_heat/activiteiten_geojson.php?afdeling="+afdId;
		// link = "activiteiten_"+afdId+".geojson"
		$.get(link, function(data){
			try{
				var dict = new Object(); 
				var activiteitenData = JSON.parse(data).features;
				for(var i = 0; i < activiteitenData.length; i++){
					var act = activiteitenData[i];
					addActivity(act, dict);
				}

				createLayer(dict);

				var centerPin = L.marker(geoCenter(dict)).addTo(map);
				centerPin.bindPopup("Geografisch centrum van <a href='https://www.jnm.be/afdeling/"+afdNaam+"' target='_blank'>"+afdNaam+"</a>");
				centerPin.on('mouseover', function(whatever){showPins(dict);});

				var layerFixed = false;
				centerPin.on('mouseout', function(whatever){if(!layerFixed){removePins(dict);}});
				centerPin.on('click', function(whatever){layerFixed = !layerFixed;});
				


			}catch(e){
				console.log(e);
			}
		});

	}

	// load data about the spaces from file, and use it
	$.get("afdelingen.json", function( data ) {
		for(var i = 0; i < data.length; i++){
			handleAfdeling(data[i].id, data[i].display_name);

		}
	});


	
	</script>


</body>
</html>
